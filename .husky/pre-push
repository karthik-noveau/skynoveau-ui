#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Read local and remote refs from stdin
while read local_ref local_sha remote_ref remote_sha
do
  # If we're deleting a branch or pushing a tag, skip the check
  if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    echo "ðŸª“ Skipping build: branch or tag deleted."
    exit 0
  fi

  # If nothing new is being pushed (already up-to-date), skip
  if git merge-base --is-ancestor "$local_sha" "$remote_sha"; then
    echo "ðŸ”„ Everything up-to-date. Skipping prebuild."
    exit 0
  fi

  # Otherwise, run the build
  echo "ðŸ”¨ Changes detected. Running prebuild..."

  # Optional cleanup
  if [ -f .prebuild-complete ]; then
    rm .prebuild-complete
    echo "ðŸ§¹ Removed outdated .prebuild-complete"
  fi

  echo "âœ… Prebuild check complete. Proceeding with push."
done

exit 0
